#cloud-config

# https://cloudinit.readthedocs.io/en/latest/topics/network-config-format-v2.html
# https://netplan.io/examples/ https://netplan.io/reference/
datasource_list: [NoCloud]
package_update: true
package_upgrade: true
package_reboot_if_required: true
write_files:
- path: /etc/sysctl.d/10-ip-forwarding.conf
  content: |
    net.ipv4.ip_forward=1
- path: /etc/network/interfaces
  append: true
  content: |
    auto bond0.${VLAN_ID_0}
      iface bond0.${VLAN_ID_0} inet static
      pre-up sleep 5
      address 192.168.100.1
      netmask 255.255.255.0
      vlan-raw-device bond0
- path: /etc/iptables/rules.v4
  content: |
    # Generated by iptables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *filter
    :INPUT ACCEPT [950:63870]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [709:82561]
    COMMIT
    # Completed on Tue Aug 24 19:16:37 2021
    # Generated by iptables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *nat
    :PREROUTING ACCEPT [35:1778]
    :INPUT ACCEPT [35:1778]
    :OUTPUT ACCEPT [95:7259]
    :POSTROUTING ACCEPT [0:0]
    -A POSTROUTING -o bond0 -j MASQUERADE
    COMMIT
    # Completed on Tue Aug 24 19:16:37 2021
- path: /etc/iptables/rules.v6
  content: |
    # Generated by ip6tables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    COMMIT
    # Completed on Tue Aug 24 19:16:37 2021
packages:
- iptables-persistent
runcmd:
- sysctl -p /etc/sysctl.d/10-ip-forwarding.conf

